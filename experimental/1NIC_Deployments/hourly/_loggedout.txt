when CLIENT_ACCEPTED {
    set citrix_logout 0
}
when ACCESS_ACL_ALLOWED {
    set type [ACCESS::session data get session.client.type]
    if { !($type starts_with "citrix") } {
        set storeWebName "storeWeb"
        set http_uri [HTTP::uri]
        if { $http_uri == "/" || ($citrix_logout eq 0 && $http_uri ends_with "login.aspx") } {
            log local0. "For [HTTP::uri] Redirecting to /Citrix/$storeWebName/"
            ACCESS::respond 302 Location "https://[HTTP::host]/Citrix/$storeWebName/"
        } elseif { $http_uri contains "Logoff" } {
            set citrix_logout 1
        } elseif { $citrix_logout eq 1 && $http_uri ends_with "login.aspx" } {
            set citrix_logout 0
            ACCESS::respond 200 content "Logged out\r\n" Connection close
            ACCESS::session remove
        }
    }
}
